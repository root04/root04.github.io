---
layout: post
title: "etckeeper"
date: 2014-04-10T06:37:00-07:00
comments: false
---

<div class='post'>
I used etckeeper to backup and version control my files under /etc.<br /><br /># in precise pangolin<br /><br />install<br />$ sudo apt-get install etckeeper<br /><br />edit config file to use git(default uses bzr)<br />$ sudo vi /etc/etckeeper/etckeeper.conf<br /><br />before edit<br /><br /># The VCS to use.<br />#VCS="hg"<br />#VCS="git" &nbsp; &lt;--- uncomment this line<br />VCS="bzr" &nbsp; &nbsp; &lt;--- comment out this line<br />#VCS="darcs"<br /><br />after edit<br /><br /><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"># The VCS to use.</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">#VCS="hg"</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">VCS="git" &nbsp; &lt;--- uncomment this line</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">#VCS="bzr" &nbsp; &nbsp; &lt;--- comment out this line</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">#VCS="darcs"</div><div><br /></div><div>initialize repository</div><div>$ sudo etckeeper init</div><div><br /></div><div>this creates and initializes git repository in /etc.</div><div>it also adds the files in /etc to the staging, so if you want to</div><div>exclude any files to be managed, you should follow the following</div><div>instructions.</div><div><br /></div><div>remove files in staging</div><div>$ cd /etc</div><div>$ sudo git rm --cached -r -f ./</div><div><br /></div><div>I'm going to use gitignore, and gitignore ignores a file only if its not&nbsp;in the staging.</div><div>thats why I removed them.</div><div><br /></div><div>edit .gitignore(its already gonna be there, generated by etckeeper)</div><div>$ cd /etc</div><div>$ sudo vi .gitignore</div><div><br /></div><div>what I will do in the ignore file is</div><div><br /></div><div>- ignore all files</div><div>- explicitly point out files I want to manage<br /><br />following .gitignore only commits these files/directories.<br /><br /><div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><br /></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">libvirt</div></div><div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">compizconfig</div></div><div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">bash_completion</div></div><div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">environment</div></div><br /><br /></div><div>=========beginngin of .gitignore=========</div><div>/* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #</div><div>/.* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# these 2 lines tells to ignore everything</div><div><br /></div><div># begin section managed by etckeeper (do not edit this section by hand)</div><div><br /></div><div><div># new and old versions of conffiles, stored by dpkg</div><div>*.dpkg-*</div><div># new and old versions of conffiles, stored by ucf</div><div>*.ucf-*</div><div><br /></div><div># old versions of files</div><div>*.old</div><div><br /></div><div># mount(8) records system state here, no need to store these</div><div>blkid.tab</div><div>blkid.tab.old</div></div><div><br /></div><div><div># some other files in /etc that typically do not need to be tracked</div><div>nologin</div><div>ld.so.cache</div><div>prelink.cache</div><div>mtab</div><div>mtab.fuselock</div><div>.pwd.lock</div><div>*.LOCK</div><div>network/run</div><div>adjtime</div><div>lvm/cache</div><div>lvm/backup</div><div>lvm/archive</div><div>X11/xdm/authdir/authfiles/*</div><div>ntp.conf.dhcp</div><div>.initctl</div><div>webmin/fsdump/*.status</div><div>webmin/webmin/oscache</div><div>apparmor.d/cache/*</div><div>service/*/supervise/*</div><div>service/*/log/supervise/*</div><div>sv/*/supervise/*</div><div>sv/*/log/supervise/*</div><div>*.elc</div><div>*.pyc</div><div>*.pyo</div><div>init.d/.depend.*</div><div>openvpn/openvpn-status.log</div><div>cups/subscriptions.conf</div><div>cups/subscriptions.conf.O</div><div><br /></div><div># editor temp files</div><div>*~</div><div>.*.sw?</div><div>.sw?</div><div>\#*\#</div><div>DEADJOE</div><div><br /></div><div># end section managed by etckeeper</div><div><br /></div><div># explicitly point files/directories I want to manage</div><div>!/libvirt</div><div>!/compizconfig</div><div>!/bash_completion</div><div>!/environment</div></div><div><br /></div><div><div>========= &nbsp; &nbsp; &nbsp;end of .gitignore &nbsp; &nbsp; &nbsp;=========</div></div><div><br /></div><div>when I installed etckeeper, it installed cron task to take a backup,</div><div>once every day, so it will be backedup everyday.</div><div><br /></div><div><div>$ cat /etc/cron.daily/etckeeper&nbsp;</div><div>#!/bin/sh</div><div>set -e</div><div>if [ -x /usr/bin/etckeeper ] &amp;&amp; [ -e /etc/etckeeper/etckeeper.conf ]; then</div><div><span class="Apple-tab-span" style="white-space: pre;"> </span>. /etc/etckeeper/etckeeper.conf</div><div><span class="Apple-tab-span" style="white-space: pre;"> </span>if [ "$AVOID_DAILY_AUTOCOMMITS" != "1" ]; then</div><div><span class="Apple-tab-span" style="white-space: pre;">  </span># avoid autocommit if an install run is in progress</div><div><span class="Apple-tab-span" style="white-space: pre;">  </span>lockfile=/var/cache/etckeeper/packagelist.pre-install</div><div><span class="Apple-tab-span" style="white-space: pre;">  </span>if [ -e "$pe" ] &amp;&amp; [ -n "$(find "$lockfile" -mtime +1)" ]; then</div><div><span class="Apple-tab-span" style="white-space: pre;">   </span>rm -f "$lockfile" # stale</div><div><span class="Apple-tab-span" style="white-space: pre;">  </span>fi</div><div><span class="Apple-tab-span" style="white-space: pre;">  </span>if [ ! -e "$lockfile" ]; then</div><div><span class="Apple-tab-span" style="white-space: pre;">   </span>AVOID_SPECIAL_FILE_WARNING=1</div><div><span class="Apple-tab-span" style="white-space: pre;">   </span>export AVOID_SPECIAL_FILE_WARNING</div><div><span class="Apple-tab-span" style="white-space: pre;">   </span>if etckeeper unclean; then</div><div><span class="Apple-tab-span" style="white-space: pre;">    </span>etckeeper commit "daily autocommit" &gt;/dev/null</div><div><span class="Apple-tab-span" style="white-space: pre;">   </span>fi</div><div><span class="Apple-tab-span" style="white-space: pre;">  </span>fi</div><div><span class="Apple-tab-span" style="white-space: pre;"> </span>fi</div><div>fi</div></div><div><br /></div><div>I also wanted to push to github after commit, so I set it up.</div><div><br /></div><div>create a script</div><div>$ sudo vi /etc/etckeeper/commit.d/40git-push</div><div><br /></div><div>=========beginngin of 40git-push=========</div><div><div>#!/bin/sh</div><div>set -e</div><div><br /></div><div>if [ "$VCS" = git ] &amp;&amp; [ -d .git ]; then</div><div>&nbsp; cd /etc/</div><div>&nbsp; git push origin master</div><div>fi</div></div><div>========= &nbsp; &nbsp; &nbsp;end &nbsp; &nbsp; &nbsp; of 40git-push=========</div><div><br /></div><div>test</div><div><div>$ sudo vi /etc/environment</div><div><br /></div><div>PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games"</div><div>EDITOR="/usr/bin/vim" &nbsp; &lt;-- add this line</div></div><div><br /></div><div>commit</div><div>$ sudo etckeeper commit "test"</div><div><br /></div><div>if it gets commited to your local repository and github, its success.</div><br /><!-- Place this tag where you want the +1 button to render. --> <br /><div class="g-plusone" data-annotation="inline" data-width="300"></div><!-- Place this tag after the last +1 button tag. --><script type="text/javascript">  (function() {     var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;     po.src = 'https://apis.google.com/js/plusone.js';     var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);   })(); </script></div>
